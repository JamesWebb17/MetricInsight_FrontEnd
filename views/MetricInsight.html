<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Inclure le fichier head.html -->
    <div id="head-placeholder"></div>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="preload" href="/stylesheets/style.css" as="style" onload="this.onload=null;this.rel='stylesheet'">

    <script src="/javascripts/app-client.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <title>MetricInsight working</title>
</head>
<body>
<!-- Inclusion du header -->
<div id="header-placeholder"></div>

<canvas id="myChart" width="400" height="200"></canvas>

<!-- Placeholder pour le footer -->
<div id="footer-placeholder"></div>

</body>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        let ctx = document.getElementById('myChart').getContext('2d');

        // Générez les données de la fonction y = x^2
        let dataX = [];
        let dataY = [];

        let myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: dataX,
                datasets: [{
                    label: 'y = x^2',
                    data: dataY,
                    borderColor: 'blue',
                    borderWidth: 1,
                    fill: false
                }]
            },
            options: {
                scales: {
                    x: [{
                        type: 'linear',
                        position: 'bottom'
                    }],
                    y: [{
                        type: 'linear',
                        position: 'left'
                    }]
                }
            }
        });

        function addDataToGraph(data) {
            console.log(data);
            for (let i = 0; i < data.length; i++) {
                dataX.push(data[i][0]);
                dataY.push(data[i][1]);
                console.log(dataX, dataY);
            }

            myChart.data.labels = dataX;
            myChart.data.datasets[0].data = dataY;
            myChart.update();

        }

        let adresseIP = "http://148.60.220.43:3001/"

        console.log("Démarrage de l'EventSource");
        let sse = new EventSource(adresseIP + 'MetricInsight/get_data');
        sse.addEventListener('message', function(e) {
            let data = JSON.parse(e.data);
            console.log(data);
            if (!data) {
                console.log('no data in event');
                return;
            }
            else if (data['end'] === -1) {
                console.log('closing connection')
                sse.close()
            }

            else {
                addDataToGraph(data['data']);
            }
        });
    });

</script>

</html>